function initCannon(){(world=new CANNON.World).gravity.set(0,0,70),world.broadphase=new CANNON.NaiveBroadphase,world.solver.iterations=10,rubber=new CANNON.Material("rubber"),rubber_rubber=new CANNON.ContactMaterial(rubber,rubber,{friction:.95,restitution:.9,contactEquationStiffness:1e5,contactEquationRelaxation:2,frictionEquationStiffness:1e8,frictionEquationRelaxation:2}),world.addContactMaterial(rubber_rubber),timeStep=1/60}function initThree(){document.addEventListener("mousedown",onMouseDown,!1),document.addEventListener("mousemove",onMouseMove,!1),HEIGHT=window.innerHeight,WIDTH=window.innerWidth,scene=new THREE.Scene,aspectRatio=WIDTH/HEIGHT,(camera=new THREE.PerspectiveCamera(fieldOfView,aspectRatio,nearPlane,farPlane)).position.x=OG_CAM_POS_X,camera.position.y=OG_CAM_POS_Y,camera.position.z=OG_CAM_POS_Z,camera.rotation.x=OG_CAM_ROT_X,camera.rotation.y=OG_CAM_ROT_Y,camera.rotation.z=OG_CAM_ROT_Z,(renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!0})).setSize(WIDTH,HEIGHT),renderer.shadowMap.enabled=!0,(container=document.getElementById("world")).appendChild(renderer.domElement),window.addEventListener("resize",handleWindowResize,!1),audioListener=new THREE.AudioListener,camera.add(audioListener),sound1=new THREE.Audio(audioListener),sound2=new THREE.Audio(audioListener),audioLoader=new THREE.AudioLoader}function handleWindowResize(){HEIGHT=window.innerHeight,WIDTH=window.innerWidth,renderer.setSize(WIDTH,HEIGHT),camera.aspect=WIDTH/HEIGHT,camera.updateProjectionMatrix()}function createLights(){hemisphereLight=new THREE.HemisphereLight(11184810,0,.9),ambientLight=new THREE.AmbientLight(7635932,.5),(shadowLight=new THREE.DirectionalLight(16777215,.9)).position.set(150,150,350),shadowLight.castShadow=!0,shadowLight.shadow.camera.left=-40,shadowLight.shadow.camera.right=40,shadowLight.shadow.camera.top=40,shadowLight.shadow.camera.bottom=-40,shadowLight.shadow.camera.near=1,shadowLight.shadow.camera.far=1e3,shadowLight.shadow.mapSize.width=2048,shadowLight.shadow.mapSize.height=2048,scene.add(hemisphereLight),scene.add(shadowLight),scene.add(ambientLight)}function createPlanes(){var e=new CANNON.Plane;groundBody=new CANNON.Body({mass:0,shape:e});var o=new THREE.BoxGeometry(300,200,1),n=new THREE.MeshPhongMaterial({transparent:!0,opacity:0});(backdrop=new THREE.Mesh(o,n)).receiveShadow=!0,backdrop.rotation.x=Math.PI/2,backdrop.position.y=-20,backdrop.position.z=25;var a=new THREE.BoxGeometry(300,200,1),t=new THREE.ShadowMaterial({opacity:.5}),r=new THREE.Mesh(a,t);r.receiveShadow=!0,scene.add(r),scene.add(backdrop),world.add(groundBody)}function addBalloons(){for(var e,o,n,a=0;a<MAX_BALLOONS;a++){switch(a){case 0:n=28,e=0,o=10;break;case 1:e=2,o=9,n=35;break;case 2:e=0,o=8,n=40;break;case 3:e=-2,o=9,n=35;break;case 4:e=-1,o=5,n=48;break;case 5:e=1,o=4.5,n=50;break;case 6:e=-2.7,o=6,n=42;break;case 7:e=2.7,o=7,n=42;break;default:e=0,o=7,n=30}balloon=new Balloon(.25,e,o,n-4,colors[a%(MAX_BALLOONS/2)]),balloonMeshes.push(balloon.mesh),balloonBodies.push(balloon.body),meshToBody(balloon.mesh,balloon.body)}}function render(){requestAnimationFrame(render),renderer.render(scene,camera),updatePhysics(),updateCamera(),checkDone()}function updateCamera(){camera.position.x=camPosX,camera.position.y=camPosY}function updatePhysics(){world.step(timeStep);for(e=0;e<balloonBodies.length;e++)balloonMeshes[e].position.copy(new THREE.Vector3(balloonBodies[e].position.x,balloonBodies[e].position.y,balloonBodies[e].position.z+3.4)),balloonBodies[e].quaternion.copy(balloonMeshes[e].quaternion);for(var e=0;e<ropeBodiesBodies.length;e++)for(var o=0;o<ropeBodiesBodies[e].length;o++)meshToBody(ropeMeshesMeshes[e][o],ropeBodiesBodies[e][o])}function meshToBody(e,o){e.position.copy(o.position),e.quaternion.copy(o.quaternion)}function init(e){initThree(),initCannon(),createLights(),createPlanes(),addBalloons(),render()}function checkDone(){0===num_balloons&&(num_balloons=1e3,setTimeout(function(){$("#world").fadeOut(3e3),setTimeout(function(){$("#button").fadeIn(2e3),setTimeout(function(){$("#button").css("-webkit-transition-duration","0.4s"),$("#button").css("transition-duration","0.4s")},1e3)},3e3)},1e3))}function onMouseMove(e){var o={currX:camPosX,currY:camPosY},n=OG_CAM_POS_X+Math.exp((e.clientX/renderer.domElement.width*2-1)/2),a=OG_CAM_POS_Y-Math.exp((e.clientY/renderer.domElement.height*2+1)/2);Math.abs(n-camPosX)>TOL&&TweenLite.to(o,1,{currX:n,onUpdate:function(){camPosX=o.currX}}),Math.abs(a-camPosY)>TOL&&TweenLite.to(o,1,{currY:a,onUpdate:function(){camPosY=o.currY}})}function onMouseDown(e){HEIGHT=window.innerHeight,WIDTH=window.innerWidth;var o=new THREE.Raycaster,n=new THREE.Vector3;n.x=e.clientX/renderer.domElement.width*2-1,n.y=-e.clientY/renderer.domElement.height*2+1,n.z=.5,n.unproject(camera),o.set(camera.position,n.sub(camera.position).normalize());var a=o.intersectObjects(balloonMeshes,!0),t=o.intersectObject(backdrop,!0);if(a[0]){var r=a[0].object.parent;null!=currBalloon?(currBalloon.color==r.color?(pop(r),t[0]&&splatterOnBackDrop(t[0].point.clone(),r.color),removeBalloonAndRopeBody(currBalloon),removeBalloonAndRopeBody(r)):(flashRed(r),unpop(currBalloon),audioLoader.load("sounds/wrong.mp3",function(e){sound2.setBuffer(e),sound2.setLoop(!1),sound2.setVolume(.3),sound2.play()})),currBalloon=null):(pop(r),t[0]&&splatterOnBackDrop(t[0].point.clone(),r.color),currBalloon=r)}}function pop(e){e.visible=!1,audioLoader.load("sounds/balloon_pop.ogg",function(e){sound1.setBuffer(e),sound1.setLoop(!1),sound1.setVolume(.3),sound1.play()});for(var o=0;o<e.rope.ropeBodies.length;o++)e.rope.ropeBodies[o].velocity.y=-1*Math.sqrt(o);setTimeout(function(o){if(0==e.visible)for(var n=0;n<e.rope.ropeMeshes.length;n++)e.rope.ropeMeshes[n].visible=!1},COLLAPSE_TIME)}function unpop(e){e.visible=!0;for(var o=0;o<e.rope.ropeMeshes.length;o++)e.rope.ropeMeshes[o].visible=!0}function splatterOnBackDrop(e,o){var n=new THREE.Vector3(-1,0,0);n.z=2*Math.random()*Math.PI;var a=8+10*Math.random(),t=splatterMaterial.clone();t.color.setHex(o);var r=new THREE.Mesh(new THREE.DecalGeometry(backdrop,e,n,new THREE.Vector3(a,a,a),new THREE.Vector3(1,1,1)),t);scene.add(r)}function flashRed(e){for(var o=0;o<e.children.length;o++)e.children[o].material.color.setHex(16594736);setTimeout(function(){for(var o=0;o<e.children.length;o++)e.children[o].material.color.setHex(BALLOONS_COLOR)},70)}function removeBalloonAndRopeBody(e){world.removeBody(e.body),setTimeout(function(){for(var o=0;o<e.rope.ropeBodies.length;o++)world.removeBody(e.rope.ropeBodies[o])},COLLAPSE_TIME),num_balloons--}var colors=[16777215*Math.random(),16777215*Math.random(),16777215*Math.random(),16777215*Math.random(),16777215*Math.random(),16777215*Math.random(),16777215*Math.random(),16777215*Math.random()],scene,camera,fieldOfView=60,aspectRatio,nearPlane=1,farPlane=1e4,renderer,container,world,timeStep,body,HEIGHT,WIDTH,audioListener,sound1,sound2,audioLoader,loader=new THREE.TextureLoader,splatterMaterial=new THREE.MeshPhongMaterial({specular:16777215,shininess:100,map:loader.load("img/splatter-diffuse.png"),normalMap:loader.load("img/splatter-normal.jpg"),normalScale:new THREE.Vector2(1,1),transparent:!0,depthTest:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-4,wireframe:!1}),rubber,rubber_rubber,OG_CAM_POS_X=-1.7444381359663044,OG_CAM_POS_Y=42,OG_CAM_POS_Z=16.58729214144528,OG_CAM_ROT_X=-Math.PI/2,OG_CAM_ROT_Y=0,OG_CAM_ROT_Z=Math.PI,camPosX=OG_CAM_POS_X,camPosY=OG_CAM_POS_Y,ambientLight,hemisphereLight,shadowLight,backdrop,groundBody,ropeBodiesBodies=[],ropeMeshesMeshes=[],Rope=function(e,o,n,a){this.ropeBodies=[],this.ropeMeshes=[],this.body=new CANNON.Body;var t=new CANNON.Box(new CANNON.Vec3(.02,.02,.52)),r=1,i=null,s=new THREE.LineBasicMaterial({color:7895160,transparent:!0,opacity:1});this.mesh=new THREE.Object3D,this.mesh.name="rope";for(var d=0;d<a;d++){r=d+1;var h=new CANNON.Body({mass:r,linearDamping:.85,angularDamping:.95});h.addShape(t),h.position.set(o,n,.52*(a-d-22)),h.velocity.x=d,this.ropeBodies.push(h),world.add(h);d===a-1?(world.addConstraint(new CANNON.PointToPointConstraint(h,new CANNON.Vec3(0,0,-.2),groundBody,new CANNON.Vec3(o,n,.2))),world.addConstraint(new CANNON.PointToPointConstraint(h,new CANNON.Vec3(0,0,.2),i,new CANNON.Vec3(0,0,-.2)))):null!==i?world.addConstraint(new CANNON.PointToPointConstraint(h,new CANNON.Vec3(0,0,.2),i,new CANNON.Vec3(0,0,-.2))):world.addConstraint(new CANNON.PointToPointConstraint(h,new CANNON.Vec3(0,0,.2),e,new CANNON.Vec3(0,-.6,0))),i=h;var l=new THREE.BoxBufferGeometry(.02,.02,.52),c=new THREE.Mesh(l,s);c.castShadow=!0,c.position.set(0,0,.52*(a-d)),this.ropeMeshes.push(c),this.mesh.add(c)}ropeMeshesMeshes.push(this.ropeMeshes),ropeBodiesBodies.push(this.ropeBodies),scene.add(this.mesh)},num_balloons=0,BALLOONS_COLOR=3355647,Balloon=function(e,o,n,a,t){this.mesh=new THREE.Object3D,this.mesh.name="balloon";var r=new THREE.MeshPhongMaterial({color:BALLOONS_COLOR,transparent:!0,opacity:.9,specular:BALLOONS_COLOR,shininess:100}),i=new THREE.SphereBufferGeometry(7,14,8,0,6.285,0,2.095),s=new THREE.Mesh(i,r);s.castShadow=!0,s.receiveShadow=!0,this.mesh.add(s);var d=new THREE.CylinderBufferGeometry(6.07,.6,12,14,8,!0,1.58,6.285),h=new THREE.Mesh(d,r);h.position.y=-9.5,h.castShadow=!0,h.receiveShadow=!0,this.mesh.add(h);var l=new THREE.OctahedronBufferGeometry,c=new THREE.Mesh(l,r);c.position.y=-15.9,c.castShadow=!0,c.receiveShadow=!0,this.mesh.add(c),this.mesh.rotation.x=Math.PI/2,this.mesh.scale.set(e,e,e),this.body=new CANNON.Body({material:rubber,mass:2,linearDamping:.99,angularDamping:1}),this.body.addShape(new CANNON.Sphere(7*e),new CANNON.Vec3(0,-1*e*c.position.y,0)),this.body.addShape(new CANNON.Box(new CANNON.Vec3(e,e,e))),this.body.quaternion.copy(this.mesh.quaternion),this.mesh.rope=new Rope(this.body,o,n,a),this.mesh.color=t,this.mesh.body=this.body,this.body.position.set(o,n,0),scene.add(this.mesh),world.add(this.body),num_balloons++},balloonMeshes=[],balloonBodies=[],MAX_BALLOONS=8,TOL=.05,currBalloon=null,COLLAPSE_TIME=1e3;window.addEventListener("load",init,!1);